---
title: "mlr3summary playground"
author: "Susanne Dandl"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load the necessary packages
```{r pkg, echo=TRUE, results='hide'}
library(mlr3)
library(mlr3learners)
library(mlr3filters)
library(mlr3pipelines)
# library(mlr3summary)

# # Developer mode!
library(devtools)
load_all()

set.seed(1812L)
```

## Regression example

The first example is based on the `mtcars` task available in `mlr3`.
We train a regression tree on it.

```{r mtcars}
tsk_cars = tsk("mtcars")
lrn_rpart = lrn("regr.rpart")
lrn_rpart$train(task = tsk_cars)
```

We can receive an overview of the model with `summary()`.

```{r summarymodel}
summary(lrn_rpart)
```

Because we have no hold-out/test data, performance results, etc. are not shown.
This is because performance evaluations on the training data can be biased due to overfitting.
To receive performance results we conduct resampling to allow for evaluations based on hold-out data.
We use the generated `ResampleResult` (here `rr_1`) as an additional input to `summary()`.

```{r resampling}
rsmp_cv3 = rsmp("cv", folds = 3)
rr_1 = resample(tsk_cars, lrn_rpart, rsmp_cv3, store_model = TRUE)
summary(lrn_rpart, rr_1)
```

Multiple performance measures are also possible to display via `mlr3::msrs`

```{r multimeas}
summary(lrn_rpart, rr_1, control = summary_control(measures = msrs(c("regr.bias", "regr.mae"))))
```

The model can also comprise multiple pre-processing steps conducted via the package `mlr3pipelines`, these will also be shown in the `summary()` output.
In the following, feature filtering is conducted based on the feature importance.
Please note that now a paragraph on the pipeline structure was added to the `summary()` output.

```{r graph}
graph = po("filter", filter = mlr3filters::flt("variance"), filter.frac = 0.5) %>>%
  po("learner", mlr3::lrn("regr.rpart"))
graph$train(tsk_cars)
rr_2 = resample(tsk_cars, graph, rsmp_cv3, store_model = TRUE)
summary(graph, rr_2)
```

Here, `graph` is a `Graph` object. It is also possible to display a `summary()` after converting it to a `GraphLearner`.

```{r graphlearner}
graph_learner = as_learner(graph)
graph_learner$train(tsk_cars)
rr_3 = resample(tsk_cars, graph_learner, rsmp_cv3, store_model = TRUE)
summary(graph_learner, rr_3)
```

Currently only linear pipelines can be displayed in `summary()`, more complex non-linear structures are only displayed by `<complex>`.

```{r complexgraph}
graph_complex = po("scale", center = TRUE, scale = FALSE) %>>%
  gunion(list(
    po("missind"),
    po("imputemedian")
  )) %>>%
  po("featureunion") %>>%
  po("learner", mlr3::lrn("regr.rpart"))
graph_complex$train(tsk_cars)
rr_4 = resample(tsk_cars, graph_complex, rsmp_cv3, store_model = TRUE)
summary(graph_complex, rr_4)
```


Multiple importance measures are also possible: 

```{r importances}
sm = summary(lrn_rpart, rr_3, control = summary_control(importance_measures = c("pfi", "pdp")))
```


Only display `n_important = 3L` most important features. 
```{r n_important}
summary(lrn_rpart, rr_3, control = summary_control(importance_measures = c("pdp"), n_important = 3L))
```

